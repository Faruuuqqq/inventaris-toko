<?= $this->extend('layout/main') ?>

<?= $this->section('content') ?>

<div class="grid gap-6 lg:grid-cols-3">
    <!-- Form Section -->
    <div class="lg:col-span-2">
        <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
            <div class="flex flex-col space-y-1.5 p-6">
                <h3 class="text-xl font-semibold flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="2" y="6" width="20" height="12" rx="2" stroke-width="2"/><circle cx="12" cy="12" r="2" stroke-width="2"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 12h.01 M18 12h.01" stroke-width="2"/></svg>
                    Form Penjualan Tunai
                </h3>
            </div>
            <div class="p-6 pt-0 space-y-6">
                <!-- Header Info -->
                <div class="grid gap-4 md:grid-cols-4">
                    <div class="space-y-2">
                        <label class="text-sm font-medium">No. Faktur</label>
                        <input type="text" value="<?= 'INV-' . date('Ymd') . '-' . str_pad(rand(1, 9999), 4, '0', STR_PAD_LEFT) ?>" disabled class="form-input">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium">Tanggal</label>
                        <input type="date" value="<?= date('Y-m-d') ?>" class="form-input">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium">Customer</label>
                        <select name="customer_id" id="customer_id" class="form-input">
                            <option value="">Pilih customer</option>
                            <?php foreach ($customers as $customer): ?>
                            <option value="<?= $customer->id ?>"><?= $customer->name ?></option>
                            <?php endforeach; ?>
                            <option value="walk">Walk-in Customer</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium">Sales</label>
                        <select name="salesperson_id" id="salesperson_id" class="form-input">
                            <option value="">Pilih sales</option>
                            <?php foreach ($salespersons as $salesperson): ?>
                            <option value="<?= $salesperson['id'] ?>"><?= $salesperson['name'] ?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                </div>

                <!-- Items Section -->
                <div class="rounded-lg border p-4">
                    <h4 class="mb-4 font-medium">Tambah Produk</h4>
                    <div class="grid gap-4 md:grid-cols-5">
                        <div class="md:col-span-2">
                            <select id="productSelect" class="form-input">
                                <option value="">Pilih produk</option>
                                <?php foreach ($products ?? [] as $product): ?>
                                <option value="<?= $product->id ?>"><?= $product->name ?> - <?= format_currency($product->price_sell) ?></option>
                                <?php endforeach; ?>
                            </select>
                        </div>
                        <input type="number" id="quantity" placeholder="Qty" class="form-input">
                        <input type="number" id="discount" placeholder="Diskon" class="form-input">
                        <button type="button" class="btn btn-primary" onclick="addItem()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v14m-7-7h14"/></svg>
                            Tambah
                        </button>
                    </div>
                </div>

                <!-- Items Table -->
                <table class="table">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Produk</th>
                            <th class="text-right">Qty</th>
                            <th class="text-right">Harga</th>
                            <th class="text-right">Diskon</th>
                            <th class="text-right">Subtotal</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="itemsTable">
                        <!-- Items will be added dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Summary Section -->
    <div>
        <div class="rounded-lg border bg-card text-card-foreground shadow-sm sticky top-24">
            <div class="flex flex-col space-y-1.5 p-6">
                <h3 class="text-xl font-semibold flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="4" y="2" width="16" height="20" rx="2" stroke-width="2"/><line x1="8" y1="6" x2="16" y2="6" stroke-width="2"/><line x1="16" y1="14" x2="16" y2="14" stroke-width="2"/><line x1="12" y1="14" x2="12" y2="14" stroke-width="2"/><line x1="8" y1="14" x2="8" y2="14" stroke-width="2"/></svg>
                    Ringkasan
                </h3>
            </div>
            <div class="p-6 pt-0 space-y-4">
                <div class="flex justify-between text-sm">
                    <span>Subtotal (<span id="totalItems">0</span> item)</span>
                    <span id="subtotal">Rp 0</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span>Diskon Total</span>
                    <span id="totalDiscount">Rp 0</span>
                </div>
                <div class="border-t pt-4">
                    <div class="flex justify-between">
                        <span class="font-semibold">Grand Total</span>
                        <span class="text-xl font-bold text-primary" id="grandTotal">Rp 0</span>
                    </div>
                </div>

                <div class="space-y-2 pt-4">
                    <label class="text-sm font-medium">Bayar</label>
                    <input type="number" id="paymentAmount" placeholder="0" class="form-input text-right text-lg">
                </div>

                <div class="flex justify-between rounded-lg p-3" style="background-color: var(--success); color: white;">
                    <span class="font-medium">Kembalian</span>
                    <span class="font-bold" id="change">Rp 0</span>
                </div>

                <div class="flex gap-2 pt-4">
                    <button type="button" class="btn btn-outline flex-1">
                        Batal
                    </button>
                    <button type="button" class="btn btn-primary flex-1" onclick="saveTransaction()">
                        Simpan
                    </button>
                </div>

                <button type="button" class="btn btn-outline w-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="6 9 6 2 18 2" stroke-width="2"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8" stroke-width="2"/></svg>
                    Cetak Struk
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let items = [];
    let productData = {};

    // Load products
    fetch('/transactions/sales/getProducts')
        .then(response => response.json())
        .then(data => {
            data.forEach(product => {
                productData[product.id] = product;
            });
        });

    function addItem() {
        const productId = document.getElementById('productSelect').value;
        const quantity = parseInt(document.getElementById('quantity').value) || 0;
        const discount = parseFloat(document.getElementById('discount').value) || 0;
        
        if (!productId || quantity <= 0) {
            alert('Pilih produk dan masukkan quantity');
            return;
        }
        
        const product = productData[productId];
        if (!product) return;
        
        const subtotal = (product.price_sell * quantity) - discount;
        
        items.push({
            id: productId,
            name: product.name,
            price: product.price_sell,
            quantity: quantity,
            discount: discount,
            subtotal: subtotal
        });
        
        renderItems();
        updateSummary();
        
        // Reset form
        document.getElementById('productSelect').value = '';
        document.getElementById('quantity').value = '';
        document.getElementById('discount').value = '';
    }

    function removeItem(index) {
        items.splice(index, 1);
        renderItems();
        updateSummary();
    }

    function renderItems() {
        const tbody = document.getElementById('itemsTable');
        tbody.innerHTML = '';
        
        items.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${item.name}</td>
                <td class="text-right">${item.quantity}</td>
                <td class="text-right">${formatCurrency(item.price)}</td>
                <td class="text-right">${formatCurrency(item.discount)}</td>
                <td class="text-right font-medium">${formatCurrency(item.subtotal)}</td>
                <td>
                    <button type="button" class="btn btn-ghost text-destructive" style="height: 32px; width: 32px; padding: 0;" onclick="removeItem(${index})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="3 6 5 6 21 6" stroke-width="2"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function updateSummary() {
        const totalItems = items.length;
        const subtotal = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const totalDiscount = items.reduce((sum, item) => sum + item.discount, 0);
        const grandTotal = subtotal - totalDiscount;
        
        document.getElementById('totalItems').textContent = totalItems;
        document.getElementById('subtotal').textContent = formatCurrency(subtotal);
        document.getElementById('totalDiscount').textContent = formatCurrency(totalDiscount);
        document.getElementById('grandTotal').textContent = formatCurrency(grandTotal);
        
        // Calculate change
        const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || 0;
        const change = paymentAmount - grandTotal;
        document.getElementById('change').textContent = formatCurrency(Math.max(0, change));
    }

    function saveTransaction() {
        const customerId = document.getElementById('customer_id').value;
        const salespersonId = document.getElementById('salesperson_id').value;
        const warehouseId = '1'; // Default warehouse
        
        if (!customerId) {
            alert('Pilih customer terlebih dahulu');
            return;
        }
        
        if (items.length === 0) {
            alert('Tambah minimal 1 produk');
            return;
        }
        
        // Create form and submit
        const form = document.createElement('form');
        form.method = 'post';
        form.action = '/transactions/sales/storeCash';
        
        // Add hidden fields
        const fields = {
            customer_id: customerId,
            salesperson_id: salespersonId,
            warehouse_id: warehouseId,
            total_amount: items.reduce((sum, item) => sum + item.subtotal, 0),
            items: items
        };
        
        for (const [key, value] of Object.entries(fields)) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = typeof value === 'object' ? JSON.stringify(value) : value;
            form.appendChild(input);
        }
        
        document.body.appendChild(form);
        form.submit();
    }

    function formatCurrency(amount) {
        return 'Rp ' + amount.toLocaleString('id-ID');
    }

    // Add event listeners
    document.getElementById('paymentAmount').addEventListener('input', updateSummary);
    
    // Include helper functions
</script>

<?= $this->endSection() ?>
